"use client";

import { useParty } from '@/lib/contexts/party-context';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Label } from '@/components/ui/label';
import { Icon } from '@/components/ui/icon';
import { icons } from 'lucide-react';
import { useState, useMemo, useEffect, useRef, useCallback, useLayoutEffect } from 'react';
import { useLanguage } from '@/lib/contexts/language-context';
import { Loader2, Sparkles, CheckCircle2, ArrowRight, Users, Baby, Heart, User, UserCheck, Calendar, ChevronDown, ChevronUp } from 'lucide-react';
import { DYNAMIC_TAGS, DynamicTag } from '@/lib/types/party';

export function PartyPlannerForm() {
  const { state, updateFormData, generatePartyPlan } = useParty();
  const { t, language, isLoading: languageLoading } = useLanguage();
  
  // ä¸»é¢˜å±•å¼€çŠ¶æ€
  const [showMoreThemes, setShowMoreThemes] = useState(false);
  
  // æœ¬åœ°çŠ¶æ€æ¥å¼ºåˆ¶é‡æ–°æ¸²æŸ“
  const [localLoading, setLocalLoading] = useState(false);

  // æ‰‹æœºç«¯æç¤ºçŠ¶æ€
  const [mobileTooltip, setMobileTooltip] = useState<{ tagId: string; content: string; visible: boolean } | null>(null);
  const longPressTimer = useRef<NodeJS.Timeout | null>(null);
  const [isMobile, setIsMobile] = useState(false);

  // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
  useEffect(() => {
    const checkIfMobile = () => {
      setIsMobile('ontouchstart' in window || navigator.maxTouchPoints > 0);
    };
    
    checkIfMobile();
    window.addEventListener('resize', checkIfMobile);
    return () => window.removeEventListener('resize', checkIfMobile);
  }, []);

  // é•¿æŒ‰æ£€æµ‹å‡½æ•°
  const handleTouchStart = useCallback((tag: DynamicTag) => {
    if (!isMobile) return;
    
    longPressTimer.current = setTimeout(() => {
      // è§¦å‘éœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
      if (navigator.vibrate) {
        navigator.vibrate(10);
      }
      
      setMobileTooltip({
        tagId: tag.id,
        content: `${tag.label} - ${tag.description}`,
        visible: true
      });
    }, 500); // 500msé•¿æŒ‰è§¦å‘
  }, [isMobile]);

  const handleTouchEnd = useCallback(() => {
    if (longPressTimer.current) {
      clearTimeout(longPressTimer.current);
      longPressTimer.current = null;
    }
  }, []);

  const handleTouchCancel = useCallback(() => {
    if (longPressTimer.current) {
      clearTimeout(longPressTimer.current);
      longPressTimer.current = null;
    }
  }, []);

  // éšè—ç§»åŠ¨ç«¯æç¤º
  const hideMobileTooltip = useCallback(() => {
    setMobileTooltip(null);
  }, []);

  // ç›‘æ§åŠ è½½çŠ¶æ€å˜åŒ–
  useEffect(() => {
    setLocalLoading(state.isLoading);
  }, [state.isLoading]);

  // ä½¿ç”¨ç»„åˆçŠ¶æ€
  const isCurrentlyLoading = state.isLoading || localLoading;

  // æ£€æŸ¥è¡¨å•æ˜¯å¦å®Œæ•´
  const isFormComplete = () => {
    const { ageGroup, gender, guestCount, venue, budget, theme, atmosphere } = state.formData;
    return ageGroup && gender && guestCount && venue && budget && theme && atmosphere;
  };

  // ç”ŸæˆæŒ‰é’®ç‚¹å‡»å¤„ç† - ç®€åŒ–ç‰ˆæœ¬
  const handleGenerateClick = async () => {
    if (!isFormComplete()) {
      return;
    }
    
    if (isCurrentlyLoading) {
      return;
    }

    // ç›´æ¥ç”Ÿæˆï¼Œä¸æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    setLocalLoading(true);
    
    try {
      await generatePartyPlan();
    } catch (error) {
      console.error('ç”Ÿæˆæ´¾å¯¹æ–¹æ¡ˆå¤±è´¥:', error);
    } finally {
      setLocalLoading(false);
    }
  };

  // å¤„ç†é€‰æ‹©å‡½æ•°
  const handleAgeGroupSelect = (ageGroup: '0-3' | '4-17' | '18-59' | '60+') => {
    // é€‰æ‹©å¹´é¾„æ®µæ—¶ï¼Œé‡ç½®æ€§åˆ«å’ŒåŠ¨æ€æ ‡ç­¾
    updateFormData({ 
      ageGroup, 
      gender: '', 
      dynamicTags: [],
      // æ ¹æ®å¹´é¾„æ®µè‡ªåŠ¨è®¾ç½®partyType
      partyType: ageGroup === '0-3' || ageGroup === '4-17' ? 'child' : ageGroup === '18-59' ? 'adult' : 'elderly'
    });
  };

  const handleGenderSelect = (gender: 'male' | 'female' | 'other') => {
    // é€‰æ‹©æ€§åˆ«æ—¶ï¼Œé‡ç½®åŠ¨æ€æ ‡ç­¾
    updateFormData({ gender, dynamicTags: [] });
  };

  const handleDynamicTagToggle = (tagId: string) => {
    const currentTags = state.formData.dynamicTags || [];
    const newTags = currentTags.includes(tagId)
      ? currentTags.filter(id => id !== tagId)
      : [...currentTags, tagId];
    updateFormData({ dynamicTags: newTags });
  };

  const handleGuestCountSelect = (count: 'small' | 'medium' | 'large') => {
    updateFormData({ guestCount: count });
  };

  const handleVenueSelect = (venue: 'home' | 'outdoor' | 'restaurant' | 'hall') => {
    updateFormData({ venue });
  };

  const handleBudgetSelect = (budget: 'budget' | 'standard' | 'premium') => {
    updateFormData({ budget });
  };

  // å¤„ç†å›ºå®šä¸»é¢˜é€‰æ‹©
  const handleThemeSelect = (themeId: string) => {
    const themeName = t(`planner.form.theme.${themeId}.title`);
    updateFormData({ theme: themeName });
  };

  const handleAtmosphereSelect = (atmosphere: string) => {
    updateFormData({ atmosphere: atmosphere as any });
  };

  // å¹´é¾„æ®µé€‰é¡¹
  const ageGroups = useMemo(() => {
    if (languageLoading) return [];
    return [
      { 
        id: '0-3', 
        icon: Baby,
        title: language === 'zh' ? 'å®å®ç”Ÿæ—¥' : 'Baby Birthday',
        subtitle: language === 'zh' ? '0-3å²ï¼Œåˆæ¬¡ä½“éªŒ' : '0-3 years, first experiences',
        value: '0-3' as const
      },
      { 
        id: '4-17', 
        icon: Users,
        title: language === 'zh' ? 'é’å°‘å¹´ç”Ÿæ—¥' : 'Teen Birthday',
        subtitle: language === 'zh' ? '4-17å²ï¼Œæˆé•¿é‡Œç¨‹ç¢‘' : '4-17 years, growing milestones',
        value: '4-17' as const
      },
      { 
        id: '18-59', 
        icon: User,
        title: language === 'zh' ? 'æˆäººç”Ÿæ—¥' : 'Adult Birthday',
        subtitle: language === 'zh' ? '18-59å²ï¼Œäººç”Ÿåº†å…¸' : '18-59 years, life celebrations',
        value: '18-59' as const
      },
      { 
        id: '60+', 
        icon: Heart,
        title: language === 'zh' ? 'é•¿è¾ˆç”Ÿæ—¥' : 'Senior Birthday',
        subtitle: language === 'zh' ? '60å²åŠä»¥ä¸Šï¼Œæ™ºæ…§ä¼ æ‰¿' : '60+ years, wisdom legacy',
        value: '60+' as const
      }
    ];
  }, [language, languageLoading]);

  // æ€§åˆ«é€‰é¡¹
  const genderOptions = useMemo(() => {
    if (languageLoading) return [];
    return [
      { 
        id: 'male', 
        label: language === 'zh' ? 'ç”·æ€§' : 'Male',
        value: 'male' as const
      },
      { 
        id: 'female', 
        label: language === 'zh' ? 'å¥³æ€§' : 'Female',
        value: 'female' as const
      },
      { 
        id: 'other', 
        label: language === 'zh' ? 'å…¶ä»–' : 'Other',
        value: 'other' as const
      }
    ];
  }, [language, languageLoading]);

  // è·å–å½“å‰å¹´é¾„æ®µçš„åŠ¨æ€æ ‡ç­¾
  const currentDynamicTags = useMemo(() => {
    if (!state.formData.ageGroup) return [];
    
    const tags = DYNAMIC_TAGS[state.formData.ageGroup] || [];
    
    // å¦‚æœå·²é€‰æ‹©æ€§åˆ«ï¼Œåˆ™è¿‡æ»¤æ ‡ç­¾ï¼›å¦‚æœæœªé€‰æ‹©æ€§åˆ«ï¼Œåˆ™æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾
    if (state.formData.gender) {
      return tags.filter(tag => 
        tag.gender === 'all' || 
        tag.gender === state.formData.gender ||
        (tag.gender === 'female' && state.formData.gender === 'other') // åŒ…å®¹æ€§å¤„ç†
      );
    } else {
      // æœªé€‰æ‹©æ€§åˆ«æ—¶ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾
      return tags;
    }
  }, [state.formData.ageGroup, state.formData.gender]);

  // èšä¼šè§„æ¨¡é€‰é¡¹
  const guestCounts = useMemo(() => {
    if (languageLoading) return [];
    return [
      { id: 'smallParty', label: t('planner.form.guestCount.smallParty'), desc: t('planner.form.guestCount.smallPartyDesc'), value: 'small' as const },
      { id: 'mediumParty', label: t('planner.form.guestCount.mediumParty'), desc: t('planner.form.guestCount.mediumPartyDesc'), value: 'medium' as const },
      { id: 'largeParty', label: t('planner.form.guestCount.largeParty'), desc: t('planner.form.guestCount.largePartyDesc'), value: 'large' as const },
    ];
  }, [t, languageLoading]);

  // åœºåœ°é€‰é¡¹
  const venues = useMemo(() => {
    if (languageLoading) return [];
    return [
      { id: 'home', label: t('planner.form.venue.home'), desc: t('planner.form.venue.homeDesc'), value: 'home' as const },
      { id: 'outdoor', label: t('planner.form.venue.outdoor'), desc: t('planner.form.venue.outdoorDesc'), value: 'outdoor' as const },
      { id: 'restaurant', label: t('planner.form.venue.restaurant'), desc: t('planner.form.venue.restaurantDesc'), value: 'restaurant' as const },
      { id: 'hall', label: t('planner.form.venue.hall'), desc: t('planner.form.venue.hallDesc'), value: 'hall' as const },
    ];
  }, [t, languageLoading]);

  // é¢„ç®—é€‰é¡¹
  const budgets = useMemo(() => {
    if (languageLoading) return [];
    return [
      { id: 'budget', label: t('planner.form.budget.budget'), desc: t('planner.form.budget.budgetDesc'), value: 'budget' as const },
      { id: 'standard', label: t('planner.form.budget.standard'), desc: t('planner.form.budget.standardDesc'), value: 'standard' as const },
      { id: 'premium', label: t('planner.form.budget.premium'), desc: t('planner.form.budget.premiumDesc'), value: 'premium' as const },
    ];
  }, [t, languageLoading]);

  // å‰6ä¸ªä¸»é¢˜ï¼ˆå¸¸æ˜¾ç¤ºï¼‰
  const themes = useMemo(() => {
    if (languageLoading) return [];
    return [
      { 
        id: 'vintage', 
        title: t('planner.form.theme.vintage.title'), 
        subtitle: t('planner.form.theme.vintage.subtitle'),
        badges: [t('planner.form.theme.vintage.badge1'), t('planner.form.theme.vintage.badge2')]
      },
      { 
        id: 'luxury', 
        title: t('planner.form.theme.luxury.title'), 
        subtitle: t('planner.form.theme.luxury.subtitle'),
        badges: [t('planner.form.theme.luxury.badge1'), t('planner.form.theme.luxury.badge2')]
      },
      { 
        id: 'modern', 
        title: t('planner.form.theme.modern.title'), 
        subtitle: t('planner.form.theme.modern.subtitle'),
        badges: [t('planner.form.theme.modern.badge1'), t('planner.form.theme.modern.badge2')]
      },
      { 
        id: 'cartoon', 
        title: t('planner.form.theme.cartoon.title'), 
        subtitle: t('planner.form.theme.cartoon.subtitle'),
        badges: [t('planner.form.theme.cartoon.badge1'), t('planner.form.theme.cartoon.badge2')]
      },
      { 
        id: 'adventure', 
        title: t('planner.form.theme.adventure.title'), 
        subtitle: t('planner.form.theme.adventure.subtitle'),
        badges: [t('planner.form.theme.adventure.badge1'), t('planner.form.theme.adventure.badge2')]
      },
      { 
        id: 'traditional', 
        title: t('planner.form.theme.traditional.title'), 
        subtitle: t('planner.form.theme.traditional.subtitle'),
        badges: [t('planner.form.theme.traditional.badge1'), t('planner.form.theme.traditional.badge2')]
      }
    ];
  }, [t, languageLoading]);

  // å6ä¸ªä¸»é¢˜ï¼ˆæŠ˜å æ˜¾ç¤ºï¼‰
  const moreThemes = useMemo(() => {
    if (languageLoading) return [];
    return [
      { 
        id: 'superhero', 
        title: t('planner.form.theme.superhero.title'), 
        subtitle: t('planner.form.theme.superhero.subtitle'),
        badges: [t('planner.form.theme.superhero.badge1'), t('planner.form.theme.superhero.badge2')]
      },
      { 
        id: 'princess', 
        title: t('planner.form.theme.princess.title'), 
        subtitle: t('planner.form.theme.princess.subtitle'),
        badges: [t('planner.form.theme.princess.badge1'), t('planner.form.theme.princess.badge2')]
      },
      { 
        id: 'space', 
        title: t('planner.form.theme.space.title'), 
        subtitle: t('planner.form.theme.space.subtitle'),
        badges: [t('planner.form.theme.space.badge1'), t('planner.form.theme.space.badge2')]
      },
      { 
        id: 'ocean', 
        title: t('planner.form.theme.ocean.title'), 
        subtitle: t('planner.form.theme.ocean.subtitle'),
        badges: [t('planner.form.theme.ocean.badge1'), t('planner.form.theme.ocean.badge2')]
      },
      { 
        id: 'garden', 
        title: t('planner.form.theme.garden.title'), 
        subtitle: t('planner.form.theme.garden.subtitle'),
        badges: [t('planner.form.theme.garden.badge1'), t('planner.form.theme.garden.badge2')]
      },
      { 
        id: 'sports', 
        title: t('planner.form.theme.sports.title'), 
        subtitle: t('planner.form.theme.sports.subtitle'),
        badges: [t('planner.form.theme.sports.badge1'), t('planner.form.theme.sports.badge2')]
      }
    ];
  }, [t, languageLoading]);

  // åŒæ­¥ä¸»é¢˜çŠ¶æ€ - å¦‚æœé€‰æ‹©çš„ä¸»é¢˜åœ¨æ›´å¤šä¸»é¢˜ä¸­ï¼Œè‡ªåŠ¨å±•å¼€
  useEffect(() => {
    const currentTheme = state.formData.theme || '';
    const isInMoreThemes = moreThemes.some(theme => theme.title === currentTheme);
    
    if (isInMoreThemes) {
      setShowMoreThemes(true);
    }
  }, [state.formData.theme, moreThemes]);

  // æ°›å›´é€‰é¡¹
  const atmospheres = useMemo(() => {
    if (languageLoading) return [];
    return [
      { id: 'quiet', label: t('planner.form.atmosphere.quiet'), desc: t('planner.form.atmosphere.quietDesc') },
      { id: 'celebration', label: t('planner.form.atmosphere.celebration'), desc: t('planner.form.atmosphere.celebrationDesc') },
      { id: 'intimate', label: t('planner.form.atmosphere.intimate'), desc: t('planner.form.atmosphere.intimateDesc') },
      { id: 'elegant', label: t('planner.form.atmosphere.elegant'), desc: t('planner.form.atmosphere.elegantDesc') },
      { id: 'joyful', label: t('planner.form.atmosphere.joyful'), desc: t('planner.form.atmosphere.joyfulDesc') },
      { id: 'warm', label: t('planner.form.atmosphere.warm'), desc: t('planner.form.atmosphere.warmDesc') },
    ];
  }, [t, languageLoading]);

  // æ¸²æŸ“é€‰æ‹©æ­¥éª¤ç»„ä»¶
  const StepCard = ({ step, title, subtitle, children, className = "" }: {
    step: number;
    title: string;
    subtitle: string;
    children: React.ReactNode;
    className?: string;
  }) => (
    <Card className={`mb-3 bg-white border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 ${className}`}>
      <CardHeader className="pb-2">
        <div className="flex items-center gap-3">
          <div className="relative">
            <div className="flex items-center justify-center w-8 h-8 rounded-full bg-primary text-white text-sm font-semibold">
              {step}
            </div>
            <div className="absolute -top-1 -right-1 w-2 h-2 bg-orange-500 rounded-full"></div>
          </div>
          <div className="flex-1">
            <CardTitle className="text-base font-semibold text-gray-900">{title}</CardTitle>
            <p className="text-xs text-gray-600 mt-0.5">{subtitle}</p>
          </div>
        </div>
      </CardHeader>
      <CardContent className="pt-0">
        {children}
      </CardContent>
    </Card>
  );

  return (
    <>
      <div className="party-planner-form space-y-3">
        {/* é¡µé¢æ ‡é¢˜ */}
        <Card className="bg-primary border border-primary shadow-sm">
          <CardHeader className="text-center py-4">
            <div className="flex items-center justify-center mb-2">
              <Sparkles className="w-5 h-5 text-white mr-2" />
              <CardTitle className="text-lg font-bold text-white">{t('planner.form.title')}</CardTitle>
              <Sparkles className="w-5 h-5 text-white ml-2" />
            </div>
            <p className="text-white/90 text-sm">{t('planner.form.subtitle')}</p>
          </CardHeader>
        </Card>

        {/* æ­¥éª¤1: æ´¾å¯¹ç±»å‹ - ä¸€æ­¥åˆ°ä½è®¾è®¡ */}
        <StepCard
          step={1}
          title={t('planner.form.partyType.title')}
          subtitle={t('planner.form.partyType.subtitle')}
        >
          <div className="space-y-5">
            {/* å¹´é¾„æ®µé€‰æ‹© */}
            <div className="grid grid-cols-2 gap-3">
              {ageGroups.map((type: any) => {
                const IconComponent = type.icon;
                const isSelected = state.formData.ageGroup === type.value;
                
                return (
                  <div
                    key={type.id}
                    className={`group relative rounded-xl border-2 cursor-pointer transition-all duration-300 ${
                      isSelected 
                        ? 'border-primary bg-primary/5 shadow-lg'
                        : 'border-gray-200 hover:border-primary/30 hover:shadow-md'
                    }`}
                    onClick={() => handleAgeGroupSelect(type.value as any)}
                  >
                    <div className="p-4 text-center space-y-2">
                      <div className={`mx-auto w-10 h-10 rounded-full flex items-center justify-center transition-all duration-300 ${
                        isSelected 
                          ? 'bg-primary text-white' 
                          : 'bg-gray-100 text-gray-600 group-hover:bg-gray-200'
                      }`}>
                        <IconComponent className="w-5 h-5" />
                      </div>
                      <div>
                        <h3 className="font-semibold text-sm text-gray-900">{type.title}</h3>
                        <p className="text-xs text-gray-500">{type.subtitle}</p>
                      </div>
                    </div>
                    
                    {isSelected && (
                      <div className="absolute top-2 right-2 w-5 h-5 bg-primary rounded-full flex items-center justify-center">
                        <CheckCircle2 className="w-3 h-3 text-white" />
                      </div>
                    )}
                  </div>
                );
              })}
            </div>

            {/* åŒæ—¶å±•ç¤ºï¼šæ€§åˆ«é€‰æ‹© + åŠ¨æ€æ ‡ç­¾ */}
            {state.formData.ageGroup && (
              <div className="bg-gray-50 rounded-xl p-4 space-y-3 border border-gray-100">
                
                {/* æ€§åˆ«é€‰æ‹© - æ¨ªå‘ç´§å‡‘å¸ƒå±€ */}
                <div className="space-y-1.5">
                  <div className="flex items-center gap-2">
                    <UserCheck className="w-4 h-4 text-indigo-600" />
                    <span className="text-sm font-medium text-gray-900">
                      {language === 'zh' ? 'æ€§åˆ«' : 'Gender'}
                    </span>
                    <div className="px-2 py-0.5 bg-orange-100 rounded text-xs text-orange-700 font-medium">
                      {language === 'zh' ? 'å½±å“å¤§' : 'High Impact'}
                    </div>
                  </div>
                  
                  <div className="flex gap-2">
                    {genderOptions.map((gender: any) => {
                      const isSelected = state.formData.gender === gender.value;
                      
                      return (
                        <button
                          key={gender.id}
                          className={`flex-1 py-1.5 px-3 rounded-lg text-sm border transition-all duration-200 ${
                            isSelected 
                              ? 'border-indigo-400 bg-indigo-50 text-indigo-700 font-medium'
                              : 'border-gray-200 text-gray-600 hover:border-indigo-300 hover:bg-indigo-25'
                          }`}
                          onClick={() => handleGenderSelect(gender.value as any)}
                        >
                          {gender.label}
                          {isSelected && <CheckCircle2 className="w-3 h-3 inline ml-1" />}
                        </button>
                      );
                    })}
                  </div>
                </div>

                {/* åŠ¨æ€æ ‡ç­¾ - æç®€æ ‡ç­¾äº‘ */}
                {currentDynamicTags.length > 0 && (
                  <div className="space-y-2 pt-1">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <Calendar className="w-4 h-4 text-purple-600" />
                        <span className="text-sm font-medium text-gray-900">
                          {language === 'zh' ? 'ç‰¹æ®Šé‡Œç¨‹ç¢‘' : 'Special Milestones'}
                        </span>
                        <span className="text-xs text-gray-500">
                          {language === 'zh' ? '(å¯é€‰)' : '(Optional)'}
                        </span>
                      </div>
                      
                      {state.formData.dynamicTags && state.formData.dynamicTags.length > 0 && (
                        <span className="text-xs text-purple-600 font-medium">
                          {state.formData.dynamicTags.length} {language === 'zh' ? 'å·²é€‰' : 'selected'}
                        </span>
                      )}
                    </div>
                    
                    {/* æç®€æ ‡ç­¾äº‘ - æœ€å°åŒ–ç©ºé—´å ç”¨ */}
                    <div className="flex flex-wrap gap-1">
                      {currentDynamicTags.map((tag: DynamicTag) => {
                        const isSelected = state.formData.dynamicTags?.includes(tag.id) || false;
                        const isRelevant = !state.formData.gender || 
                          tag.gender === 'all' || 
                          tag.gender === state.formData.gender ||
                          (tag.gender === 'female' && state.formData.gender === 'other');
                        
                        return (
                          <button
                            key={tag.id}
                            className={`px-2 py-1 rounded text-xs border transition-all duration-200 hover:scale-105 ${
                              isSelected 
                                ? 'border-purple-400 bg-purple-100 text-purple-700 font-medium shadow-sm'
                                : isRelevant
                                  ? 'border-gray-200 text-gray-600 hover:border-purple-300 hover:bg-purple-50'
                                  : 'border-gray-100 text-gray-400 bg-gray-50 hover:border-gray-200'
                            }`}
                            onClick={() => handleDynamicTagToggle(tag.id)}
                            onTouchStart={() => handleTouchStart && handleTouchStart(tag)}
                            onTouchEnd={handleTouchEnd}
                            onTouchCancel={handleTouchCancel}
                            title={`${tag.label} - ${tag.description}${!isRelevant ? ` (${language === 'zh' ? 'é€‰æ‹©å¯¹åº”æ€§åˆ«åå¯ç”¨' : 'Available after selecting relevant gender'})` : ''}`}
                          >
                            {tag.label}
                            {isSelected && <span className="ml-1">âœ“</span>}
                            {!isRelevant && <span className="ml-1 opacity-50">*</span>}
                          </button>
                        );
                      })}
                    </div>
                    
                    {/* ç§»åŠ¨ç«¯æç¤ºæ¡† */}
                    {mobileTooltip && mobileTooltip.visible && (
                      <div 
                        className="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
                        onClick={hideMobileTooltip}
                      >
                        <div className="bg-white rounded-lg p-4 mx-4 max-w-sm shadow-lg">
                          <p className="text-sm text-gray-800 leading-relaxed">{mobileTooltip.content}</p>
                          <div className="mt-3 text-center">
                            <button 
                              className="px-4 py-2 bg-primary text-white rounded-lg text-sm"
                              onClick={hideMobileTooltip}
                            >
                              {language === 'zh' ? 'çŸ¥é“äº†' : 'Got it'}
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    <div className="pt-2 border-t border-gray-200/50">
                      <p className="text-xs text-gray-500">
                        {language === 'zh' 
                          ? `ğŸ’¡ ${isMobile ? 'é•¿æŒ‰æŸ¥çœ‹è¯¦æƒ…' : 'æ‚¬åœæŸ¥çœ‹è¯¦æƒ…'} â€¢ é€‰é¡¹è¶Šè¯¦ç»†ï¼Œç”Ÿæˆç»“æœä¼šè®©æ‚¨æ›´æ»¡æ„` 
                          : `ğŸ’¡ ${isMobile ? 'Long press for details' : 'Hover for details'} â€¢ More detailed options lead to better results`
                        }
                      </p>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        </StepCard>

        {/* æ­¥éª¤2: èšä¼šè§„æ¨¡ */}
        <StepCard
          step={2}
          title={t('planner.form.guestCount.title')}
          subtitle={t('planner.form.guestCount.subtitle')}
        >
          <div className="grid grid-cols-3 gap-3">
            {guestCounts.map((count: any) => {
              const isSelected = state.formData.guestCount === count.value;
              
              return (
                <div
                  key={count.id}
                  className={`p-3 rounded-lg border cursor-pointer transition-all duration-200 text-center ${
                    isSelected 
                      ? 'border-primary bg-primary/5 shadow-sm'
                      : 'border-gray-200 hover:border-primary/50 hover:bg-gray-50'
                  }`}
                  onClick={() => handleGuestCountSelect(count.value as any)}
                >
                  <div className={`w-2 h-2 rounded-full mx-auto mb-2 transition-colors ${
                    isSelected ? 'bg-primary' : 'bg-gray-300'
                  }`} />
                  <h4 className="font-semibold text-sm text-gray-900 mb-1">{count.label}</h4>
                  <p className="text-xs text-gray-500">{count.desc}</p>
                  {isSelected && (
                    <CheckCircle2 className="w-4 h-4 text-primary mx-auto mt-2" />
                  )}
                </div>
              );
            })}
          </div>
        </StepCard>

        {/* æ­¥éª¤3: åœºåœ°é€‰æ‹© */}
        <StepCard
          step={3}
          title={t('planner.form.venue.title')}
          subtitle={t('planner.form.venue.subtitle')}
        >
          <div className="grid grid-cols-2 gap-3">
            {venues.map((venue: any) => {
              const isSelected = state.formData.venue === venue.value;
              
              return (
                <div
                  key={venue.id}
                  className={`p-3 rounded-lg border cursor-pointer transition-all duration-200 text-center ${
                    isSelected 
                      ? 'border-primary bg-primary/5 shadow-sm'
                      : 'border-gray-200 hover:border-primary/50 hover:bg-gray-50'
                  }`}
                  onClick={() => handleVenueSelect(venue.value as any)}
                >
                  <div className={`w-2 h-2 rounded-full mx-auto mb-2 transition-colors ${
                    isSelected ? 'bg-primary' : 'bg-gray-300'
                  }`} />
                  <h4 className="font-semibold text-sm text-gray-900 mb-1">{venue.label}</h4>
                  <p className="text-xs text-gray-500 leading-relaxed">{venue.desc}</p>
                  {isSelected && (
                    <CheckCircle2 className="w-4 h-4 text-primary mx-auto mt-2" />
                  )}
                </div>
              );
            })}
          </div>
        </StepCard>

        {/* æ­¥éª¤4: é¢„ç®—è®¾ç½® */}
        <StepCard
          step={4}
          title={t('planner.form.budget.title')}
          subtitle={t('planner.form.budget.subtitle')}
        >
          <div className="grid grid-cols-3 gap-3">
            {budgets.map((budget: any) => {
              const isSelected = state.formData.budget === budget.value;
              
              return (
                <div
                  key={budget.id}
                  className={`p-3 rounded-lg border cursor-pointer transition-all duration-200 text-center ${
                    isSelected 
                      ? 'border-primary bg-primary/5 shadow-sm'
                      : 'border-gray-200 hover:border-primary/50 hover:bg-gray-50'
                  }`}
                  onClick={() => handleBudgetSelect(budget.value as any)}
                >
                  <div className={`